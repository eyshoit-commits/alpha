name: BKG CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Cargo test
        run: cargo test --workspace

  api-schema:
    runs-on: ubuntu-latest
    needs: lint-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Node (for OpenAPI validation)
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install schema tooling
        run: npm install -g ajv-cli @redocly/openapi-cli

      - name: Generate OpenAPI schema
        run: make api-schema

      - name: Ensure OpenAPI schema committed
        run: git diff --exit-code -- openapi.yaml

      - name: Validate OpenAPI schema
        run: openapi-cli validate openapi.yaml

      - name: Validate cave.yaml if present
        run: |
          if [ -f "cave.yaml" ]; then
            ajv validate -s schema/cave.schema.json -d cave.yaml
          else
            echo "cave.yaml not found, skipping schema validation."
          fi

  security-tests:
    runs-on: ubuntu-latest
    needs: lint-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security test dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "tests/security/requirements.txt" ]; then
            python -m pip install -r tests/security/requirements.txt
          else
            python -m pip install pytest
          fi

      - name: Run security tests
        run: pytest tests/security

  web-ui:
    runs-on: ubuntu-latest
    needs: lint-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install workspace dependencies
        working-directory: web
        run: npm install

      - name: Install Playwright browsers
        working-directory: web
        run: npx playwright install --with-deps

      - name: Lint admin app
        working-directory: web
        run: npm run lint -w admin

      - name: Lint namespace app
        working-directory: web
        run: npm run lint -w app

      - name: Build admin app
        working-directory: web/admin
        run: npm run build

      - name: Build namespace app
        working-directory: web/app
        run: npm run build

      - name: Run Playwright tests
        working-directory: web
        env:
          CI: "true"
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web/playwright-report
          if-no-files-found: ignore

  supply-chain:
    runs-on: ubuntu-latest
    needs: [api-schema, security-tests, web-ui]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Install Syft (SBOM)
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM
        run: make sbom

      - name: Generate SLSA provenance
        run: make slsa

      - name: Sign SBOM when key is provided
        env:
          COSIGN_EXPERIMENTAL: "1"
          COSIGN_KEY_B64: ${{ secrets.COSIGN_KEY_B64 }}
        run: |
          if [ -n "${COSIGN_KEY_B64}" ]; then
            echo "Using cosign key from secrets"
            echo "${COSIGN_KEY_B64}" | base64 -d > cosign.key
            cosign sign-blob sbom.json --key cosign.key --output-signature sbom.sig
          elif [ -f "cosign.key" ]; then
            cosign sign-blob sbom.json --key cosign.key --output-signature sbom.sig
          else
            echo "Skipping cosign signing; provide COSIGN_KEY_B64 secret or cosign.key artifact to enable signing."
          fi

      - name: Upload supply chain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-artifacts
          path: |
            sbom.json
            slsa.json
            sbom.sig
          if-no-files-found: ignore
