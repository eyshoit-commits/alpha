{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Cave Project Configuration Schema",
  "description": "JSON Schema for cave.yaml - project and sandbox configuration used by `bkg` CLI.",
  "type": "object",
  "required": ["project", "version", "sandboxes"],
  "additionalProperties": false,
  "properties": {
    "project": {
      "type": "string",
      "minLength": 1,
      "description": "Human readable project identifier (slug)."
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+(\\.[0-9]+)?$",
      "description": "Project config version (semantic style)."
    },
    "description": {
      "type": "string",
      "description": "Optional longer project description."
    },
    "default": {
      "type": "object",
      "description": "Optional defaults applied to sandboxes",
      "properties": {
        "cpus": {
          "type": "integer",
          "minimum": 1,
          "maximum": 64,
          "default": 2
        },
        "memory_mb": {
          "type": "integer",
          "minimum": 128,
          "maximum": 262144,
          "default": 1024
        },
        "timeout_s": {
          "type": "integer",
          "minimum": 1,
          "maximum": 86400,
          "default": 120
        },
        "image_pull_policy": {
          "type": "string",
          "enum": ["IfNotPresent", "Always", "Never"],
          "default": "IfNotPresent"
        }
      },
      "additionalProperties": false
    },
    "sandboxes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["name", "image", "start"],
        "additionalProperties": false,
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^[a-zA-Z0-9_\\-]+$",
            "description": "Sandbox name (used in namespaces and paths)."
          },
          "image": {
            "type": "string",
            "description": "Runtime image or runtime alias (e.g., python:3.11, node:20, wasm)."
          },
          "cpus": {
            "type": "integer",
            "minimum": 1,
            "maximum": 64,
            "description": "vCPU quota."
          },
          "memory_mb": {
            "type": "integer",
            "minimum": 128,
            "maximum": 262144,
            "description": "Memory in MiB."
          },
          "timeout_s": {
            "type": "integer",
            "minimum": 1,
            "maximum": 86400,
            "description": "Max execution time in seconds for runs in this sandbox."
          },
          "disk_mb": {
            "type": "integer",
            "minimum": 10,
            "maximum": 1048576,
            "default": 1024,
            "description": "Workspace disk quota."
          },
          "start": {
            "type": "string",
            "description": "Start command for persistent sandboxes (shell command)."
          },
          "env": {
            "type": "object",
            "description": "Key/value environment variables applied to the sandbox.",
            "additionalProperties": {
              "type": ["string", "number", "boolean", "null"]
            }
          },
          "labels": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            }
          },
          "network": {
            "type": "string",
            "enum": ["off", "egress-allowlist", "unrestricted"],
            "default": "egress-allowlist",
            "description": "Network profile for the sandbox."
          },
          "gpu": {
            "type": "integer",
            "minimum": 0,
            "maximum": 8,
            "default": 0,
            "description": "Number of GPUs assigned (0 = none)."
          },
          "annotations": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            }
          }
        }
      }
    },
    "policies": {
      "type": "array",
      "description": "Optional policy snippets or references (IDs) that should be applied to project sandboxes.",
      "items": {
        "type": "string"
      }
    }
  }
}
